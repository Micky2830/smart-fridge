<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Login & Signup - Firebase Auth</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        .container { background: #fff; border-radius: 10px; box-shadow:0 15px 30px rgba(0,0,0,0.1); width:100%; max-width:400px; overflow: hidden; }
        .form-container { padding: 30px; }
        .tabs { display:flex; margin-bottom:20px; }
        .tab { flex:1; text-align:center; padding:10px; cursor:pointer; border-bottom:2px solid #eee; font-weight:600; color:#888; }
        .tab.active { color:#667eea; border-bottom:2px solid #667eea; }
        h2 { text-align:center; margin-bottom:20px; color:#333; }
        .form-group { margin-bottom:15px; }
        label { display:block; margin-bottom:5px; font-weight:500; color:#555; }
        input { width:100%; padding:12px; border:1px solid #ddd; border-radius:5px; font-size:16px; transition: border .3s; }
        input:focus { border-color:#667eea; outline:none; }
        button { width:100%; padding:12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:5px; font-size:16px; cursor:pointer; transition: opacity .3s; }
        button:hover { opacity:.9; }
        .message { margin-top:15px; text-align:center; color:#666; font-size:14px; }
        .message a { color:#667eea; text-decoration:none; }
        .alert { padding:10px; border-radius:5px; margin-bottom:15px; display:none; }
        .alert-success { background:#d4edda; color:#155724; }
        .alert-error { background:#f8d7da; color:#721c24; }
    </style>
</head>
<body>
<div class="container">
    <div class="tabs">
        <div class="tab active" id="login-tab">Login</div>
        <div class="tab" id="signup-tab">Sign Up</div>
    </div>

    <div class="form-container">
        <div id="login-form">
            <h2>Welcome Back</h2>
            <div id="login-alert" class="alert"></div>
            <div class="form-group">
                <label for="login-email">Email</label>
                <input type="email" id="login-email" placeholder="Enter your email"/>
            </div>
            <div class="form-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" placeholder="Enter your password"/>
            </div>
            <button id="login-btn">Login</button>
            <div class="message">Don't have an account? <a href="#" id="to-signup">Sign Up</a></div>
        </div>

        <div id="signup-form" style="display:none;">
            <h2>Create Account</h2>
            <div id="signup-alert" class="alert"></div>
            <div class="form-group">
                <label for="signup-email">Email</label>
                <input type="email" id="signup-email" placeholder="Enter your email"/>
            </div>
            <div class="form-group">
                <label for="signup-password">Password</label>
                <input type="password" id="signup-password" placeholder="Create a password (min. 6 characters)"/>
            </div>
            <div class="form-group">
                <label for="confirm-password">Confirm Password</label>
                <input type="password" id="confirm-password" placeholder="Confirm your password"/>
            </div>
            <button id="signup-btn">Sign Up</button>
            <div class="message">Already have an account? <a href="#" id="to-login">Login</a></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

    // Firebase config (correct storage bucket: appspot.com)
    const firebaseConfig = {
        apiKey: "AIzaSyBtber_vI7Um--ZMaewPuTl8OGb9RDsxqM",
        authDomain: "kahseng-9092f.firebaseapp.com",
        databaseURL: "https://kahseng-9092f-default-rtdb.firebaseio.com",
        projectId: "kahseng-9092f",
        storageBucket: "kahseng-9092f.appspot.com",
        messagingSenderId: "676092858157",
        appId: "1:676092858157:web:1fd51f23c334584ce00da4",
        measurementId: "G-NBJLZ62N4N"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const auth = getAuth(app);

    // DOM elements
    const loginTab   = document.getElementById('login-tab');
    const signupTab  = document.getElementById('signup-tab');
    const loginForm  = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const toSignup   = document.getElementById('to-signup');
    const toLogin    = document.getElementById('to-login');
    const loginBtn   = document.getElementById('login-btn');
    const signupBtn  = document.getElementById('signup-btn');
    const loginAlert = document.getElementById('login-alert');
    const signupAlert = document.getElementById('signup-alert');

    // Switch tabs
    loginTab.addEventListener('click', () => {
        loginTab.classList.add('active');
        signupTab.classList.remove('active');
        loginForm.style.display = 'block';
        signupForm.style.display = 'none';
    });
    signupTab.addEventListener('click', () => {
        signupTab.classList.add('active');
        loginTab.classList.remove('active');
        signupForm.style.display = 'block';
        loginForm.style.display = 'none';
    });
    toSignup.addEventListener('click', e => { e.preventDefault(); signupTab.click(); });
    toLogin.addEventListener('click', e => { e.preventDefault(); loginTab.click(); });

    // Helpers
    function showAlert(el, message, type) {
        el.textContent = message;
        el.classList.remove('alert-success', 'alert-error');
        el.classList.add(type === 'success' ? 'alert-success' : 'alert-error');
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 5000);
    }
    async function jsonOrError(res) {
        let data;
        try { data = await res.json(); } catch { data = { success:false, message:'Server returned non-JSON' }; }
        if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
        return data;
    }
    function checkAuthStatus() {
        fetch('/check_session')
            .then(r => r.json())
            .then(d => { if (d.logged_in) window.location.href = '/main'; })
            .catch(() => {});
    }

    // Login
    loginBtn.addEventListener('click', async () => {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;

        if (!email || !password) return showAlert(loginAlert, 'Please fill in all fields', 'error');

        try {
            const { user } = await signInWithEmailAndPassword(auth, email, password);
            const idToken = await user.getIdToken();
            const data = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify({ idToken })
            }).then(jsonOrError);

            showAlert(loginAlert, data.message || 'Login successful', 'success');
            setTimeout(() => { window.location.href = data.redirect || '/main'; }, 800);
        } catch (err) {
            showAlert(loginAlert, err.message || 'Server error. Please try again.', 'error');
        }
    });

    // Signup â†’ create in Firebase client, then call /login with idToken
    signupBtn.addEventListener('click', async () => {
        const email = document.getElementById('signup-email').value.trim();
        const password = document.getElementById('signup-password').value;
        const confirm = document.getElementById('confirm-password').value;

        if (!email || !password || !confirm) return showAlert(signupAlert, 'Please fill in all fields', 'error');
        if (password !== confirm) return showAlert(signupAlert, 'Passwords do not match', 'error');
        if (password.length < 6) return showAlert(signupAlert, 'Password must be at least 6 characters', 'error');

        try {
            const { user } = await createUserWithEmailAndPassword(auth, email, password);
            const idToken = await user.getIdToken();

            // Use /login so that we always set uid + user in server session
            const data = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify({ idToken })
            }).then(jsonOrError);

            showAlert(signupAlert, 'Sign up successful', 'success');
            setTimeout(() => { window.location.href = data.redirect || '/main'; }, 800);
        } catch (err) {
            let msg = err.message || 'Server error.';
            if (err.code === 'auth/email-already-in-use') msg = 'An account with this email already exists.';
            else if (err.code === 'auth/invalid-email') msg = 'Invalid email address format.';
            else if (err.code === 'auth/weak-password') msg = 'Password is too weak.';
            showAlert(signupAlert, msg, 'error');
        }
    });

    // On load
    checkAuthStatus();
</script>
</body>
</html>
