<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Food Detection Dashboard</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:#f5f7fa;min-height:100vh}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);padding:20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .welcome h1{font-size:24px;margin-bottom:5px}
    .welcome p{opacity:.9}
    .uid{opacity:.8;font-size:12px}
    .live{display:inline-flex;align-items:center;gap:6px;font-size:12px;background:rgba(255,255,255,.2);padding:6px 10px;border-radius:999px}
    .live-dot{width:8px;height:8px;border-radius:50%;background:#0fd66f;opacity:.5;transition:opacity .2s, transform .2s}
    .live-dot.flash{opacity:1;transform:scale(1.4)}
    .logout-btn{padding:10px 20px;background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);border-radius:5px;cursor:pointer;font-size:16px;transition:all .3s}
    .logout-btn:hover{background:rgba(255,255,255,.3)}

    .nav-tabs{display:flex;background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.05);margin-bottom:20px;overflow:hidden}
    .tab{padding:15px 20px;cursor:pointer;transition:all .3s;text-align:center;flex:1;border-bottom:3px solid transparent}
    .tab:hover{background:#f8f9fa}
    .tab.active{border-bottom:3px solid #667eea;color:#667eea;font-weight:600}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:10px 0 20px}
    .controls select,.controls input[type="range"]{padding:8px 12px;border:1px solid #ddd;border-radius:6px}
    .controls label{display:flex;align-items:center;gap:8px;color:#333}

    .stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.05);padding:20px;text-align:center}
    .stat-card h3{color:#667eea;font-size:32px;margin-bottom:10px}
    .stat-card p{color:#666}

    .dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-bottom:30px}
    .card{background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.05);padding:20px;transition:transform .3s}
    .card:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(0,0,0,.1)}
    .card h3{color:#333;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #eee}
    .card p{color:#666;line-height:1.6;margin-bottom:8px}
    .food-image{width:100%;height:180px;background:#f0f2f5;border-radius:8px;margin:15px 0;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .food-image img{max-width:100%;max-height:100%;object-fit:cover}
    .confidence{display:inline-block;padding:3px 8px;border-radius:12px;font-size:12px;font-weight:600}
    .high-confidence{background:#e6f7ee;color:#00a65a}
    .medium-confidence{background:#fff4e6;color:#ff8c00}
    .low-confidence{background:#fde8ea;color:#cc2b3e}

    .profile-section{background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.05);padding:25px;margin-bottom:20px}
    .profile-section h2{color:#333;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #eee}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:500;color:#555}
    .form-group input{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:5px;font-size:16px;transition:border .3s}
    .form-group input:focus{border-color:#667eea;outline:none}
    .save-btn{padding:12px 25px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:5px;font-size:16px;cursor:pointer;transition:opacity .3s}
    .save-btn:hover{opacity:.9}

    @media (max-width:768px){
      .dashboard{grid-template-columns:1fr}
      .nav-tabs{flex-direction:column}
      header{flex-direction:column;text-align:center;gap:15px}
      .stats-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="welcome">
        <h1>Food Detection Dashboard</h1>
        <p>Welcome, <span id="user-email">user@example.com</span> <span class="uid" id="uid-badge"></span></p>
      </div>
      <div class="live"><span class="live-dot" id="live-dot"></span> Live updates</div>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </header>

    <div class="nav-tabs">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="profile">Profile</div>
      <div class="tab" data-tab="edit-profile">Edit Profile</div>
      <div class="tab" data-tab="security">Security</div>
    </div>

    <!-- Dashboard -->
    <div class="tab-content active" id="dashboard-tab">
      <div class="controls">
        <label>Camera:
          <select id="camFilter"><option value="">All cameras</option></select>
        </label>
        <label>Min confidence:
          <input id="minConf" type="range" min="0" max="100" value="0"/>
          <span id="minConfVal">0%</span>
        </label>
      </div>

      <div class="stats-grid">
        <div class="stat-card"><h3 id="total-detections">0</h3><p>Total Detections</p></div>
        <div class="stat-card"><h3 id="recognized-count">0</h3><p>Recognized Items</p></div>
        <div class="stat-card"><h3 id="avg-confidence">0%</h3><p>Average Confidence</p></div>
      </div>

      <h2 style="margin-bottom:20px;color:#333;">Recent Food Detections</h2>
      <div class="dashboard" id="food-cards"></div>
    </div>

    <!-- Profile -->
    <div class="tab-content" id="profile-tab">
      <div class="profile-section">
        <h2>Profile Information</h2>
        <div class="form-group">
          <label>Email Address</label>
          <input id="profile-email" type="email" value="user@example.com" readonly/>
        </div>
        <div class="form-group">
          <label>Account Created</label>
          <input id="profile-created" type="text" value="" readonly/>
        </div>
        <div class="form-group">
          <label>Last Login</label>
          <input id="profile-lastlogin" type="text" value="" readonly/>
        </div>
      </div>
    </div>

    <!-- Edit Profile -->
    <div class="tab-content" id="edit-profile-tab">
      <div class="profile-section">
        <h2>Edit Profile</h2>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" value=""/>
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input id="edit-email" type="email" value=""/>
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" value=""/>
        </div>
        <button class="save-btn" disabled>Save Changes</button>
      </div>
    </div>

    <!-- Security -->
    <div class="tab-content" id="security-tab">
      <div class="profile-section">
        <h2>Security Settings</h2>
        <div class="form-group">
          <label>Current Password</label>
          <input type="password" placeholder="Enter current password" disabled/>
        </div>
        <div class="form-group">
          <label>New Password</label>
          <input type="password" placeholder="Enter new password" disabled/>
        </div>
        <div class="form-group">
          <label>Confirm New Password</label>
          <input type="password" placeholder="Confirm new password" disabled/>
        </div>
        <button class="save-btn" disabled>Update Password</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBtber_vI7Um--ZMaewPuTl8OGb9RDsxqM",
      authDomain: "kahseng-9092f.firebaseapp.com",
      databaseURL: "https://kahseng-9092f-default-rtdb.firebaseio.com",
      projectId: "kahseng-9092f",
      storageBucket: "kahseng-9092f.appspot.com",
      messagingSenderId: "676092858157",
      appId: "1:676092858157:web:1fd51f23c334584ce00da4",
      measurementId: "G-NBJLZ62N4N"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // UI refs
    const emailEl = document.getElementById('user-email');
    const uidBadge = document.getElementById('uid-badge');
    const logoutBtn = document.getElementById('logoutBtn');
    const cardsEl = document.getElementById('food-cards');
    const totalEl = document.getElementById('total-detections');
    const recogEl = document.getElementById('recognized-count');
    const avgEl = document.getElementById('avg-confidence');
    const profileEmail = document.getElementById('profile-email');
    const profileCreated = document.getElementById('profile-created');
    const profileLast = document.getElementById('profile-lastlogin');
    const editEmail = document.getElementById('edit-email');
    const camFilter = document.getElementById('camFilter');
    const minConf = document.getElementById('minConf');
    const minConfVal = document.getElementById('minConfVal');
    const liveDot = document.getElementById('live-dot');

    let lastItems = [];

    // Tabs
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });

    logoutBtn.addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));

    // Filters
    minConf.addEventListener('input', ()=>{
      minConfVal.textContent = minConf.value + '%';
      renderFoodData(lastItems);
    });
    camFilter.addEventListener('change', ()=>renderFoodData(lastItems));

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href='index.html'; return; }

      emailEl.textContent = user.email || user.uid;
      uidBadge.textContent = `(uid: ${user.uid})`;
      profileEmail.value = user.email || user.uid;
      editEmail.value = user.email || '';
      try{
        const creation  = user.metadata?.creationTime ? new Date(user.metadata.creationTime) : null;
        const lastSignIn= user.metadata?.lastSignInTime ? new Date(user.metadata.lastSignInTime) : null;
        if(creation)  profileCreated.value = creation.toLocaleString();
        if(lastSignIn)profileLast.value    = lastSignIn.toLocaleString();
      }catch{}

      const path = `users/${user.uid}/food_detections`;
      const detectionsRef = ref(db, path);
      console.log('Reading path:', path);

      // One-time explicit read to surface permission errors
      try{
        const snap = await get(detectionsRef);
        console.log('Initial read exists:', snap.exists(), 'rows:', snap.exists()? Object.keys(snap.val()||{}).length : 0);
      }catch(e){
        console.error('DB read error:', e.code, e.message);
        alert('Database read failed: '+e.code+' â€” check your RTDB Rules.');
      }

      // Live updates
      onValue(detectionsRef, (snap)=>{
        flashLiveDot();
        const data = snap.val() || {};
        const items = objectToSortedArray(data);
        renderFoodData(items);
      });
    });

    function flashLiveDot(){
      liveDot.classList.add('flash');
      setTimeout(()=>liveDot.classList.remove('flash'), 200);
    }

    function objectToSortedArray(obj){
      return Object.entries(obj).map(([id, v])=>({id, ...v}))
        .sort((a,b)=>Number(b.timestamp||0)-Number(a.timestamp||0));
    }

    function populateCamFilter(items){
      const ids = [...new Set(items.map(i=>i.camera_id).filter(Boolean))];
      const current = camFilter.value;
      camFilter.innerHTML = '<option value="">All cameras</option>' + ids.map(id=>`<option>${escapeHtml(id)}</option>`).join('');
      if(ids.includes(current)) camFilter.value = current;
    }

    function getImageSrc(item){
      if(item.image_url) return item.image_url;              // preferred (from Storage)
      if(item.food_img_base64) return `data:image/jpeg;base64,${item.food_img_base64}`; // fallback
      const label = encodeURIComponent(item.food_name || 'No Image');
      return `https://via.placeholder.com/300x180/667eea/ffffff?text=${label}`;
    }

    function confidenceClass(pct){
      if(pct>=90) return 'high-confidence';
      if(pct>=60) return 'medium-confidence';
      return 'low-confidence';
    }

    function renderFoodData(items){
      lastItems = items.slice(); // keep
      populateCamFilter(items);

      const selCam = camFilter.value;
      const threshold = Number(minConf.value)/100;

      const filtered = items.filter(i=>{
        const passCam = !selCam || i.camera_id===selCam;
        const conf = Number(i.confidence_score||0);
        const passConf = conf >= threshold;
        return passCam && passConf;
      });

      cardsEl.innerHTML = '';
      let total = filtered.length, recognized = 0, sumConf = 0;

      filtered.forEach(item=>{
        const conf = Number(item.confidence_score||0);
        const pct  = Math.round(conf*100);
        if(item.status==='recognized') recognized++;
        sumConf += conf;

        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <h3>${escapeHtml(item.food_name || 'Unknown')}</h3>
          <div class="food-image">
            <img src="${getImageSrc(item)}" alt="${escapeHtml(item.food_name||'')}">
          </div>
          <p><strong>Camera:</strong> ${escapeHtml(item.camera_id || '-')}</p>
          <p><strong>Status:</strong> ${escapeHtml(item.status || '-')}</p>
          <p><strong>Confidence:</strong> <span class="confidence ${confidenceClass(pct)}">${isNaN(pct)?'0':pct}%</span></p>
          <p><strong>Date Captured:</strong> ${escapeHtml(item.date_captured || '')}</p>
        `;
        cardsEl.appendChild(div);
      });

      totalEl.textContent = total;
      recogEl.textContent = recognized;
      avgEl.textContent = total ? `${Math.round((sumConf/total)*100)}%` : '0%';
      minConfVal.textContent = minConf.value + '%';
    }

    function escapeHtml(s){
      return String(s??'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
